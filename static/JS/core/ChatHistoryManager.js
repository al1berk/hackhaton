// static/js/core/ChatHistoryManager.js

class ChatHistoryManager {
    constructor(app) {
        this.app = app;
        this.currentChatId = null;
        this.chats = [];
        this.isLoading = false;
        
        this.initializeEventListeners();
        this.loadChatHistory();
    }

    initializeEventListeners() {
        // Yeni sohbet butonu
        const newChatBtn = document.querySelector('.new-chat-btn');
        if (newChatBtn) {
            newChatBtn.addEventListener('click', () => this.createNewChat());
        }

        // Chat list event delegation
        const chatList = document.getElementById('chatList');
        if (chatList) {
            chatList.addEventListener('click', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    const chatId = chatItem.dataset.chatId;
                    if (chatId) {
                        this.loadChat(chatId);
                    }
                }

                // Silme butonu
                if (e.target.classList.contains('delete-chat-btn')) {
                    e.stopPropagation();
                    const chatId = e.target.closest('.chat-item').dataset.chatId;
                    this.deleteChat(chatId);
                }
            });
        }
    }

    async loadChatHistory() {
        if (this.isLoading) return;
        
        try {
            this.isLoading = true;
            const response = await fetch('/chats');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                this.chats = data.chats;
                this.renderChatList();
                console.log(`‚úÖ ${this.chats.length} sohbet y√ºklendi`);
            } else {
                console.error('‚ùå Sohbet y√ºkleme ba≈üarƒ±sƒ±z:', data);
            }
            
        } catch (error) {
            console.error('‚ùå Sohbet ge√ßmi≈üi y√ºkleme hatasƒ±:', error);
            this.showError('Sohbet ge√ßmi≈üi y√ºklenirken hata olu≈ütu');
        } finally {
            this.isLoading = false;
        }
    }

    async createNewChat() {
        try {
            const response = await fetch('/chats/new', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                // Yeni sohbeti listeye ekle
                this.chats.unshift(data.chat);
                this.renderChatList();
                
                // Yeni sohbeti y√ºkle
                await this.loadChat(data.chat.id);
                
                console.log('‚úÖ Yeni sohbet olu≈üturuldu:', data.chat.id);
            } else {
                throw new Error(data.message || 'Sohbet olu≈üturulamadƒ±');
            }
            
        } catch (error) {
            console.error('‚ùå Yeni sohbet olu≈üturma hatasƒ±:', error);
            this.showError('Yeni sohbet olu≈üturulurken hata olu≈ütu');
        }
    }

    async loadChat(chatId) {
        if (this.currentChatId === chatId) {
            console.log('‚ÑπÔ∏è Aynƒ± sohbet zaten a√ßƒ±k:', chatId);
            return;
        }

        try {
            // UI'yi loading durumuna getir
            this.showLoadingState();
            
            const response = await fetch(`/chats/${chatId}`);
            
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('Sohbet bulunamadƒ±');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                this.currentChatId = chatId;
                
                // Sohbet listesindeki aktif durumu g√ºncelle
                this.updateActiveChatInList(chatId);
                
                // Mesajlarƒ± temizle ve y√ºkle
                this.clearMessages();
                this.loadMessages(data.messages);
                
                // PDF istatistiklerini g√ºncelle
                if (data.vector_store_stats) {
                    this.app.updatePDFStats(data.vector_store_stats);
                }
                
                // WebSocket baƒülantƒ±sƒ±nƒ± bu chat i√ßin yeniden kur
                this.app.ws.reconnectWithChatId(chatId);
                
                console.log('‚úÖ Sohbet y√ºklendi:', chatId);
                console.log('üìä Mesaj sayƒ±sƒ±:', data.messages.length);
                
            } else {
                throw new Error(data.message || 'Sohbet y√ºklenemedi');
            }
            
        } catch (error) {
            console.error('‚ùå Sohbet y√ºkleme hatasƒ±:', error);
            this.showError(`Sohbet y√ºklenirken hata olu≈ütu: ${error.message}`);
        } finally {
            this.hideLoadingState();
        }
    }

    async deleteChat(chatId) {
        if (!confirm('Bu sohbeti silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.')) {
            return;
        }

        try {
            const response = await fetch(`/chats/${chatId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                // Listeden kaldƒ±r
                this.chats = this.chats.filter(chat => chat.id !== chatId);
                this.renderChatList();
                
                // Eƒüer silinen sohbet aktif sohbet ise, yeni sohbet olu≈ütur
                if (this.currentChatId === chatId) {
                    await this.createNewChat();
                }
                
                console.log('‚úÖ Sohbet silindi:', chatId);
                this.showSuccess('Sohbet ba≈üarƒ±yla silindi');
                
            } else {
                throw new Error(data.message || 'Sohbet silinemedi');
            }
            
        } catch (error) {
            console.error('‚ùå Sohbet silme hatasƒ±:', error);
            this.showError(`Sohbet silinirken hata olu≈ütu: ${error.message}`);
        }
    }

    renderChatList() {
        const chatList = document.getElementById('chatList');
        if (!chatList) return;

        if (this.chats.length === 0) {
            chatList.innerHTML = `
                <div class="empty-chat-list">
                    <i class="fas fa-comments"></i>
                    <p>Hen√ºz sohbet yok</p>
                    <small>Yeni sohbet ba≈ülatmak i√ßin yukarƒ±daki butona tƒ±klayƒ±n</small>
                </div>
            `;
            return;
        }

        chatList.innerHTML = this.chats.map(chat => this.renderChatItem(chat)).join('');
    }

    renderChatItem(chat) {
        const isActive = chat.id === this.currentChatId;
        const updatedDate = new Date(chat.updated_at);
        const timeAgo = this.getTimeAgo(updatedDate);
        
        // Son mesajƒ± kƒ±salt
        const lastMessage = chat.last_message || 'Hen√ºz mesaj yok';
        const truncatedMessage = lastMessage.length > 50 
            ? lastMessage.substring(0, 50) + '...' 
            : lastMessage;

        return `
            <div class="chat-item ${isActive ? 'active' : ''}" data-chat-id="${chat.id}">
                <div class="chat-item-header">
                    <div class="chat-item-title" title="${chat.title}">
                        ${this.escapeHtml(chat.title)}
                    </div>
                    <div class="chat-item-actions">
                        <span class="chat-item-time">${timeAgo}</span>
                        <button class="delete-chat-btn" title="Sohbeti Sil">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="chat-item-preview" title="${this.escapeHtml(lastMessage)}">
                    ${this.escapeHtml(truncatedMessage)}
                </div>
                <div class="chat-item-stats">
                    <span class="stat-item">
                        <i class="fas fa-comment"></i>
                        ${chat.message_count || 0}
                    </span>
                    <span class="stat-item">
                        <i class="fas fa-file-pdf"></i>
                        ${chat.pdf_count || 0}
                    </span>
                </div>
            </div>
        `;
    }

    updateActiveChatInList(chatId) {
        const chatItems = document.querySelectorAll('.chat-item');
        chatItems.forEach(item => {
            if (item.dataset.chatId === chatId) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }

    loadMessages(messages) {
        if (!messages || messages.length === 0) {
            // Ho≈ü geldin mesajƒ±nƒ± g√∂ster
            this.showWelcomeMessage();
            return;
        }

        // Ho≈ü geldin mesajƒ±nƒ± gizle
        this.hideWelcomeMessage();

        // Mesajlarƒ± y√ºkle
        messages.forEach(message => {
            if (message.type === 'user') {
                this.app.ui.addMessage(message.content, 'user');
            } else if (message.type === 'ai') {
                this.app.ui.addMessage(message.content, 'ai');
            }
        });

        // En alta scroll et
        this.app.ui.scrollToBottom();
    }

    clearMessages() {
        const messagesContainer = document.getElementById('messagesContainer');
        if (messagesContainer) {
            messagesContainer.innerHTML = '';
        }
    }

    showWelcomeMessage() {
        const messagesContainer = document.getElementById('messagesContainer');
        if (messagesContainer && !messagesContainer.querySelector('.welcome-message')) {
            messagesContainer.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h2>Merhaba! üëã</h2>
                    <p>Size nasƒ±l yardƒ±mcƒ± olabilirim? A≈üaƒüƒ±daki konularda uzmanƒ±m:</p>
                    <div class="feature-list">
                        <div class="feature-item"><i class="fas fa-search"></i> Web ara≈ütƒ±rmasƒ±</div>
                        <div class="feature-item"><i class="fas fa-file-pdf"></i> PDF dok√ºman analizi</div>
                        <div class="feature-item"><i class="fas fa-brain"></i> Akƒ±llƒ± soru-cevap</div>
                        <div class="feature-item"><i class="fas fa-chart-line"></i> Veri analizi</div>
                    </div>
                </div>
            `;
        }
    }

    hideWelcomeMessage() {
        const welcomeMessage = document.querySelector('.welcome-message');
        if (welcomeMessage) {
            welcomeMessage.style.display = 'none';
        }
    }

    showLoadingState() {
        const messagesContainer = document.getElementById('messagesContainer');
        if (messagesContainer) {
            messagesContainer.innerHTML = `
                <div class="loading-chat">
                    <div class="loading-spinner"></div>
                    <p>Sohbet y√ºkleniyor...</p>
                </div>
            `;
        }
    }

    hideLoadingState() {
        const loadingChat = document.querySelector('.loading-chat');
        if (loadingChat) {
            loadingChat.remove();
        }
    }

    // Utility methods
    getTimeAgo(date) {
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) return 'Az √∂nce';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} dk √∂nce`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} sa √∂nce`;
        if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} g√ºn √∂nce`;
        
        return date.toLocaleDateString('tr-TR');
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    showError(message) {
        // Basit error notification
        console.error('‚ùå', message);
        // Gelecekte toast notification eklenebilir
    }

    showSuccess(message) {
        // Basit success notification  
        console.log('‚úÖ', message);
        // Gelecekte toast notification eklenebilir
    }

    // Public methods
    getCurrentChatId() {
        return this.currentChatId;
    }

    updateChatTitle(chatId, newTitle) {
        const chat = this.chats.find(c => c.id === chatId);
        if (chat) {
            chat.title = newTitle;
            this.renderChatList();
        }
    }

    updateChatStats(chatId, messageCount, pdfCount) {
        const chat = this.chats.find(c => c.id === chatId);
        if (chat) {
            chat.message_count = messageCount;
            chat.pdf_count = pdfCount;
            chat.updated_at = new Date().toISOString();
            this.renderChatList();
        }
    }
}

export default ChatHistoryManager;